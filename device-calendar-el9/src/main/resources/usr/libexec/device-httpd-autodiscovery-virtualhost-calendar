#!/bin/bash

if [ $# -eq 3 ]; then

  instance="${1}"
  virtualhost="${2}"

  #
  # Handle calendar locations
  
  # find /etc/device/services/mail/calendar/ -mindepth 1 -maxdepth 1 -type l
  while read line; do

    if test -f "$line/disabled.bin"; then
      logger -t $0 "Mail calendar disabled, ignoring: $(basename ${line})"
      continue;
    fi
 
    if test ! -f "$line/virtualhost.d/listen.d/instance.d/name.txt" -o "${instance}" != "$(head -n 1 $line/virtualhost.d/listen.d/instance.d/name.txt)"; then
      continue;
    fi
    if test ! -f "$line/virtualhost.d/name.txt" -o "${virtualhost}" != "$(head -n 1 $line/virtualhost.d/name.txt)"; then
      continue;
    fi

    # read in the path if present
    path="/calendar"
    if test -f "${line}/path.txt"; then
      path="$(head ${line}/path.txt)"
    fi
    # empty path becomes a /
    if test -z "${path}";then
      path="/"
    fi

    # read ldap if present
    if [ -L "/etc/device/services/mail/ldap/ldap-suffix.d" ]; then

      # ldap instance if present
      ldap_instance=""
      if test -f "/etc/device/services/mail/ldap/ldap-suffix.d/instance.d/name.txt"; then
        ldap_instance="$(head -n 1 /etc/device/services/mail/ldap/ldap-suffix.d/instance.d/name.txt)"
      else
        logger -t "${0}" "Error: LDAP enabled, but /etc/device/services/mail/ldap/ldap-suffix.d/instance.d/name.txt missing, calendar ignored: $(basename ${line})"
        continue
      fi
      # ldap suffix if present
      ldap_suffix=""
      if test -f "/etc/device/services/mail/ldap/ldap-suffix.d/suffix.txt"; then
        ldap_suffix="$(head -n 1 /etc/device/services/mail/ldap/ldap-suffix.d/suffix.txt)"
      else
        logger -t "${0}" "Error: LDAP enabled, but /etc/device/services/mail/ldap/ldap-suffix.d/suffix.txt missing, calendar ignored: $(basename ${line})"
        continue
      fi
      uris="ldapi://%2frun%2fslapd-${ldap_instance}.socket"
    fi

    # access url if present
    access_url=""
    access_text=""
    if test -f "$line/access-url.txt"; then
      access_url="$(head -n 1 ${line}/access-url.txt)"
      if test -n "${access_url}"; then
        access_text=" To request access, <a href='$(echo ${access_url} | recode ..html)'>click here</a>."
      fi
    fi

    cat >> "device-${instance}-${virtualhost}-calendar.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

<IfModule !alias_module>
  LoadModule alias_module modules/mod_alias.so
</IfModule>
<IfModule !authz_core_module>
  LoadModule authz_core_module modules/mod_authz_core.so
</IfModule>
<IfModule !ldap_module>
  LoadModule ldap_module modules/mod_ldap.so
</IfModule>
<IfModule !authnz_ldap_module>
  LoadModule authnz_ldap_module modules/mod_authnz_ldap.so
</IfModule>
<IfModule !autoindex_module>
  LoadModule autoindex_module modules/mod_autoindex.so
</IfModule>
<IfModule !dav_module>
  LoadModule dav_module modules/mod_dav.so
</IfModule>
<IfModule !dav_fs_module>
  LoadModule dav_fs_module modules/mod_dav_fs.so
</IfModule>
<IfModule !dir_module>
  LoadModule dir_module modules/mod_dir.so
</IfModule>
<IfModule !setenvif_module>
  LoadModule setenvif_module modules/mod_setenvif.so
</IfModule>

Redirect /.well-known/caldav ${path}/

<Location ${path}>

  Alias /var/www/dav/calendar/
  AliasPreservePath on

  Dav on
  DavAccess on
  DavCalendar on
  Options +Indexes

  DavAccessPriviledge all
  DavAccessPrincipalUrl ${path}/principals/%{escape:%{REMOTE_USER}}/
  DavCalendarHome ${path}/calendars/%{escape:%{REMOTE_USER}}/
  DavCalendarProvision ${path}/calendars/%{escape:%{REMOTE_USER}}/ %{REMOTE_USER}
  DavCalendarTimezone UTC

  IndexOptions FancyIndexing HTMLTable VersionSort XHTML
  DirectoryIndex disabled
  FileETag INode MTime Size

  AuthzSendForbiddenOnFailure on

  <If "%{SSL_CLIENT_VERIFY} == 'SUCCESS' || %{SSL_CLIENT_VERIFY} == 'GENEROUS'">

    SSLUserName SSL_CLIENT_CERT_RFC4523_CEA

    LDAPBind mechanism EXTERNAL
    AuthLDAPURL ldapi://%2frun%2fslapd-${ldap_instance}.socket/${ldap_suffix}?uid,inetSubscriberAccountId?sub?inetSubscriberAccountId=*
    AuthLDAPRemoteUserAttribute inetSubscriberAccountId

    ErrorDocument 403 "<html><head><title>403 Forbidden</title></head><body><h1>Forbidden</h1><p>Your gadget '%{SSL_CLIENT_S_DN_CN}' currently does not have permission to access this URL.${access_text}</p></body></html>"

  </If>
  <Else>

    AuthType basic
    AuthName Calendar
    AuthBasicProvider ldap

    LDAPBind mechanism EXTERNAL
    AuthLDAPURL ldapi://%2frun%2fslapd-${ldap_instance}.socket/${ldap_suffix}?mail?sub

    ErrorDocument 403 "<html><head><title>403 Forbidden</title></head><body><h1>Forbidden</h1><p>Neither a digital certificate, nor a valid pass phrase was provided.${access_text}</p></body></html>"

  </Else>

  SetEnvIf REQUEST_URI "^${path}/calendars/([^/]+)" MATCH_USER=\$1

  <RequireAll>
    require valid-user
    require expr %{env:MATCH_USER} == '' || %{unescape:%{env:MATCH_USER}} == %{REMOTE_USER}
  </RequireAll>

</Location>

<Location ${path}/principals>

  Alias /var/www/dav/calendar/principals
  AliasPreservePath off

  DavAccessPrincipal on

</Location>
EOF

    install "device-${instance}-${virtualhost}-calendar.conf" "/etc/httpd/conf.device.d/instance/${instance}/secure-${virtualhost}.d/location-$(echo ${path} | tr [:cntrl:][:punct:] _).conf"

  done < <(find /etc/device/services/mail/calendar/ -mindepth 1 -maxdepth 1 -type l)

fi


